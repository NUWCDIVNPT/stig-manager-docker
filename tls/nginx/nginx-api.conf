events {
  worker_connections  4096;  ## Default: 1024
}

http {
    map_hash_bucket_size 128;
    map $uri $secured_url {
        default true;
        "/auth/realms/stigman/protocol/openid-connect/certs" false;
        "/auth/realms/stigman/.well-known/openid-configuration" false;
        ~^/stigman.* false;
    }

    map "$secured_url:$ssl_client_verify" $return_unauthorized {
            default 0;
            "true:FAILED" 1;
            "true:NONE" 1;
            "true:" 1;
    }

    server {
        listen              443 ssl;
        server_name         localhost;
        ssl_certificate     /etc/nginx/cert.pem;
        ssl_certificate_key /etc/nginx/privkey.pem;
        ssl_prefer_server_ciphers on;
        
        error_log  /var/log/nginx/error.log debug;

        root        /usr/share/nginx/html;
        if ($return_unauthorized) { return 496; }

        location / {
            autoindex on;
            ssi on;
        }
        location /stigman/ {
            proxy_pass          http://api:54000/;
        }
    }
}
